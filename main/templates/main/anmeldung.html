{% load static %}
<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>Anmeldung</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  </head>

  <body>
    <nav class="nav-container">
      <img src="{% static 'css/amslogo.png' %}" alt="Logo" class="logo" />
      <ul class="nav-links">
        <li>
          <a href="/">Home</a>
        </li>
        <li>
          <a href="/about/">Über uns</a>
        </li>
        <a href="{% url 'anmeldung' %}" class="btn">Jetzt zur Veranstaltung anmelden</a>
        <a href="/contact/" class="btn">Jetzt Kontakt aufnehmen</a>
      </ul>
    </nav>

    <h1>Anmeldung zu den Veranstaltungen</h1>
    <form method="post">
      {% csrf_token %}

      <label for="id_vorname">Vorname:</label>
      {{ form.vorname }}
      <p>
        <label for="id_nachname">Nachname:</label>
        {{ form.nachname }}
      </p>
      <p>
        <label for="id_email">E-Mail:</label>
        {{ form.email }}
      </p>
      <p>
        <label for="id_bemerkung">Bemerkung:</label>
        {{ form.bemerkung }}
      </p>
      <p>
        <label for="id_termin">Termin:</label>
        {{ form.termin }} {# KORREKT: Nur Django-Feld verwenden #}

        <label for="id_fahrzeugtyp">Fahrzeugtyp:</label>
        {{ form.fahrzeugtyp }} {# KORREKT: Nur Django-Feld verwenden #}
      </p>
      <p>
        <button type="button" id="absenden-button">Jetzt anmelden</button>
      </p>
    </form>
    <script>
      // Funktion zum Holen des CSRF-Tokens (benötigt, falls du csrf_exempt entfernst)
      function getCookie(name) {
        let cookieValue = null
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';')
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim()
            if (cookie.substring(0, name.length + 1) === name + '=') {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1))
              break
            }
          }
        }
        return cookieValue
      }
      
      document.getElementById('absenden-button').addEventListener('click', function () {
        const csrfToken = getCookie('csrftoken')
      
        const data = {
          vorname: document.querySelector('#id_vorname').value,
          nachname: document.querySelector('#id_nachname').value,
          email: document.querySelector('#id_email').value,
          bemerkung: document.querySelector('#id_bemerkung').value,
          termin: document.querySelector('#id_termin').value,
          fahrzeugtyp: document.querySelector('#id_fahrzeugtyp').value
        }
      
        fetch('/anmeldung/ajax/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify(data)
        })
          .then((response) => response.json())
          .then((result) => {
            if (result.anmeldung_id) {
              // Optionale Anzeige oder Logging
              console.log('Anmeldung erfolgreich:', result.anmeldung_id)
      
              // Optional: verstecktes Feld anlegen (falls du es brauchst)
              let hiddenField = document.createElement('input')
              hiddenField.type = 'hidden'
              hiddenField.id = 'id_anmeldung_id_hidden_field'
              hiddenField.value = result.anmeldung_id
              document.querySelector('form').appendChild(hiddenField)
      
              // Jetzt sauber redirecten
              window.location.href = `/anmeldung-erfolgreich/?anmeldung_id=${result.anmeldung_id}`
            } else {
              alert('Fehler bei der Anmeldung.')
              console.error(result)
            }
          })
          .catch((error) => {
            console.error('Fehler beim Speichern:', error)
            alert('Anmeldung konnte nicht gespeichert werden.')
          })
      })
    </script>
  </body>
</html>
