{% load static %}
<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Anmeldung</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>

<body>

    <nav class="nav-container">
        <img src="{% static 'css/amslogo.png' %}" alt="Logo" class="logo">
        <ul class="nav-links">
            <li><a href="/">Home</a></li>
            <li><a href="/about/">Über uns</a></li>
            <a href="{% url 'anmeldung' %}" class="btn">Jetzt zur Veranstaltung anmelden</a>
            <a href="/contact/" class="btn">Jetzt Kontakt aufnehmen</a>
        </ul>
    </nav>

    <h1>Anmeldung zu den Veranstaltungen</h1>
    <form method="post">
        {% csrf_token %}

        <p>
            <label for="id_vorname">Vorname:</label><br>
            {{ form.vorname }}
        </p>
        <p>
            <label for="id_nachname">Nachname:</label><br>
            {{ form.nachname }}
        </p>
        <p>
            <label for="id_email">E-Mail:</label><br>
            {{ form.email }}
        </p>
        <p>
            <label for="id_bemerkung">Bemerkung:</label><br>
            {{ form.bemerkung }}
        </p>
        <p>
            <label for="id_termin">Termin:</label><br>
            {{ form.termin }}
        </p>
        <p>
            <label for="id_fahrzeugtyp">Fahrzeugtyp:</label><br>
            {{ form.fahrzeugtyp }}
        </p>

        {% if anmeldung %}
            <input type="hidden" id="id_anmeldung_id_hidden_field" value="{{ anmeldung.id }}">
        {% endif %}

        <p><strong>Mitgliedschaftsbeitrag:</strong> Bitte begleichen Sie den Beitrag für die kommenden 6 Monate in Höhe von 10 Euro über PayPal.</p>

        <label>Mit PayPal bezahlen:</label>
        <div id="paypal-button-container"></div>

        <p><button type="submit">Abschicken</button></p>
    </form>

    <script src="https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=EUR&intent=capture&components=buttons,funding"></script>
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.addEventListener("DOMContentLoaded", function () {
            const anmeldungId = document.querySelector('#id_anmeldung_id_hidden_field')?.value || '';
            const fahrzeugtyp = document.querySelector('#id_fahrzeugtyp')?.value || '';
            let amount = '10.00'; // Default-Wert

            const renderButton = (fundingSource) => {
                paypal.Buttons({
                    style: {
                        layout: 'vertical',
                        shape: 'rect',
                        color: 'blue',
                        label: 'pay',
                    },
                    fundingSource: fundingSource,
                    createOrder: function (data, actions) {
                        return fetch('/paypal/create-order/', {
                            method: 'post',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                amount: amount,
                                anmeldung_id: anmeldungId
                            })
                        }).then(res => res.json()).then(orderData => orderData.id);
                    },
                    onApprove: function (data) {
                        return fetch('/paypal/capture-order/', {
                            method: 'post',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                orderID: data.orderID
                            })
                        }).then(res => res.json()).then(orderData => {
                            alert('Zahlung erfolgreich! Transaktion: ' + orderData.id);
                            // Optional: Formular absenden oder Weiterleitung
                            // document.querySelector('form').submit();
                        });
                    },
                    onCancel: function () {
                        alert('Zahlung abgebrochen.');
                    },
                    onError: function (err) {
                        console.error('PayPal Fehler:', err);
                        alert('Fehler bei PayPal-Zahlung.');
                    }
                }).render('#paypal-button-container');
            };

            renderButton(paypal.FUNDING.PAYPAL); // PayPal
            if (paypal.FUNDING.CARD) renderButton(paypal.FUNDING.CARD); // Kreditkarte
            if (paypal.FUNDING.SEPA) renderButton(paypal.FUNDING.SEPA); // Lastschrift
        });
    </script>

</body>
</html>